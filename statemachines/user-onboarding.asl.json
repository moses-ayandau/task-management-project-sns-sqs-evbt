{
    "Comment": "A state machine that handles the user onboarding process and SNS topic subscriptions",
    "StartAt": "SubscribeToSNSTopics",
    "States": {
      "SubscribeToSNSTopics": {
        "Type": "Parallel",
        "Branches": [
          {
            "StartAt": "SubscribeToTaskAssignmentTopic",
            "States": {
              "SubscribeToTaskAssignmentTopic": {
                "Type": "Task",
                "Resource": "arn:aws:states:::lambda:invoke",
                "Parameters": {
                  "FunctionName": "${SubscribeFunctionArn}",
                  "Payload": {
                    "action": "subscribe",
                    "topicArn": "${TaskAssignmentNotificationTopicArn}",
                    "protocol": "email",
                    "endpoint.$": "$.email"
                  }
                },
                "End": true
              }
            }
          },
          {
            "StartAt": "SubscribeToTaskDeadlineTopic",
            "States": {
              "SubscribeToTaskDeadlineTopic": {
                "Type": "Task",
                "Resource": "arn:aws:states:::lambda:invoke",
                "Parameters": {
                  "FunctionName": "${SubscribeFunctionArn}",
                  "Payload": {
                    "action": "subscribe",
                    "topicArn": "${TaskDeadlineNotificationTopicArn}",
                    "protocol": "email",
                    "endpoint.$": "$.email"
                  }
                },
                "End": true
              }
            }
          },
          {
            "StartAt": "SubscribeToClosedTaskTopic",
            "States": {
              "SubscribeToClosedTaskTopic": {
                "Type": "Task",
                "Resource": "arn:aws:states:::lambda:invoke",
                "Parameters": {
                  "FunctionName": "${SubscribeFunctionArn}",
                  "Payload": {
                    "action": "subscribe",
                    "topicArn": "${ClosedTaskNotificationTopicArn}",
                    "protocol": "email",
                    "endpoint.$": "$.email"
                  }
                },
                "End": true
              }
            }
          }
        ],
        "Next": "SendWelcomeEmail"
      },
      "SendWelcomeEmail": {
        "Type": "Task",
        "Resource": "arn:aws:states:::sns:publish",
        "Parameters": {
          "TopicArn": "${TaskAssignmentNotificationTopicArn}",
          "Message": {
            "default.$": "States.Format('Welcome to the Task Management System, {}! Your account has been created.', $.name)"
          },
          "MessageAttributes": {
            "email": {
              "DataType": "String",
              "StringValue.$": "$.email"
            }
          }
        },
        "End": true
      }
    }
  }